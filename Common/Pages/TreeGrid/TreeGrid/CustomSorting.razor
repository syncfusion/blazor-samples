@page "/tree-grid/customsorting"
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.TreeGrid
@using Syncfusion.Blazor.Buttons


@*Hidden:Lines*@
@using TaskData
@inherits SampleBaseComponent;
@inject NavigationManager NavigationManager
@inject Microsoft.AspNetCore.Components.NavigationManager UriHelper
@*End:Hidden*@

<SampleDescription>
    <p>
        This sample demonstrates applying custom sorting in the Tree Grid, where a column orders values based on user-defined logic instead of the default sort.
    </p>
</SampleDescription>

<ActionDescription>
    <p>
        Sorting is enabled by setting the <a target="_blank" href="https://help.syncfusion.com/cr/blazor/Syncfusion.Blazor.TreeGrid.SfTreeGrid-1.html#Syncfusion_Blazor_TreeGrid_SfTreeGrid_1_AllowSorting">AllowSorting</a> property to <b>true</b>, allowing column headers to be clicked to sort the data.
    </p>

    <p>
        This demo showcases how to apply custom sorting logic using the  <a href="https://help.syncfusion.com/cr/blazor/Syncfusion.Blazor.TreeGrid.html">

            SortComparer</a> property on specific columns:
        <ul>
            <li>
                <b>Priority</b>: When sorted in ascending order, values follow the sequence <b>Low</b> → <b>Normal</b> → <b>High</b> → <b>Critical</b>, so the list reflects increasing importance. When sorted in descending order, the sequence is reversed to <b>Critical</b> → <b>High</b> → <b>Normal</b> → <b>Low</b>, ensuring the most urgent items appear first instead of the default alphabetical result.
            </li>
            <li>
                <b>Story Points</b>: In ascending order, string values are treated as numbers, producing the correct sequence <b>3, 5, 30</b> rather than the alphabetical order <b>"3", "30", "5"</b>. In descending order, the numeric order is reversed to <b>30, 5, 3</b>, making larger story points appear at the top.
            </li>
        </ul>
    </p>



    <p>
        More information about custom sorting in Tree Grid can be found in this
        <a target="_blank" href="https://blazor.syncfusion.com/documentation/treegrid/sorting#custom-sorting">documentation</a> section.
    </p>
</ActionDescription>





<div class="col-lg-12 control-section">
    <div class="content-wrapper">
        <div class="row">
            <SfTreeGrid ID="treeCustomSorting" DataSource="@TreeGridData" 
                        IdMapping="TaskID" 
                        ParentIdMapping="ParentID" 
                        TreeColumnIndex="1" 
                        AllowFiltering="true" 
                        AllowSorting="true" 
                        Height="500">
                <TreeGridFilterSettings Type="Syncfusion.Blazor.TreeGrid.FilterType.Excel"></TreeGridFilterSettings>
                <TreeGridColumns>
                    <TreeGridColumn Field="TaskID" HeaderText="Task ID" Width="100" TextAlign="TextAlign.Right"></TreeGridColumn>
                    <TreeGridColumn Field="TaskName" HeaderText="Task Name" Width="280"></TreeGridColumn>
                    <TreeGridColumn Field="AssignedTo" HeaderText="Assignee" Width="140"></TreeGridColumn>

                    <TreeGridColumn Field="Priority" HeaderText="Priority" Width="120" SortComparer="@(new PriorityComparer())">
                        <Template>
                            @{
                                var task = (context as TaskData);
                                var priority = task?.Priority;
                            }
                            @if (priority == "Critical")
                            {
                                <div class="title-temp1 critical">
                                    <img src="@UriHelper.ToAbsoluteUri($"{SampleService?.WebAssetsPath}images/data-grid/critical.png")" class="priority" />
                                    <span class="font">@priority</span>
                                </div>
                            }
                            else if (priority == "High")
                            {
                                <div class="title-temp1 high">
                                    <img src="@UriHelper.ToAbsoluteUri($"{SampleService?.WebAssetsPath}images/data-grid/high.png")" class="priority" />
                                    <span class="font">@priority</span>
                                </div>
                            }
                            else if (priority == "Normal")
                            {
                                <div class="title-temp1 normal">
                                    <img src="@UriHelper.ToAbsoluteUri($"{SampleService?.WebAssetsPath}images/data-grid/normal.png")" class="priority" />
                                    <span class="font">@priority</span>
                                </div>
                            }
                            else if (priority == "Low")
                            {
                                <div class="title-temp1 low">
                                    <img src="@UriHelper.ToAbsoluteUri($"{SampleService?.WebAssetsPath}images/data-grid/low.png")" class="priority" />
                                    <span class="font">@priority</span>
                                </div>
                            }
                        </Template>
                    </TreeGridColumn>

                    <!-- StoryPoints: Direct binding, no Template, numeric string sorting -->
                    <TreeGridColumn Field="StoryPoints" 
                                    HeaderText="Story Points" 
                                    Width="110" 
                                    TextAlign="TextAlign.Center"
                                    SortComparer="@(new StoryPointsStringComparer())" ClipMode="ClipMode.EllipsisWithTooltip">
                    </TreeGridColumn>

                    <TreeGridColumn Field="Progress" HeaderText="Status" Width="130">
                        <Template>
                            @{
                                var data = (context as TaskData);
                                var pillClass = data?.Progress switch
                                {
                                    "In Progress" => "pill-started",
                                    "Started" => "pill-started",
                                    "Open" => "pill-open",
                                    _ => "pill-instatus"
                                };
                            }
                            <span class="status-pill @pillClass">@data?.Progress</span>
                        </Template>
                    </TreeGridColumn>

                    <TreeGridColumn Field="StartDate" HeaderText="Start Date" Format="d" Type="ColumnType.Date" Width="120"></TreeGridColumn>
                    <TreeGridColumn Field="EndDate" HeaderText="End Date" Format="d" Type="ColumnType.Date" Width="120"></TreeGridColumn>
                </TreeGridColumns>
            </SfTreeGrid>
        </div>
    </div>
</div>

<style>
    #treeCustomSorting .priority { height: 16px; width: 16px; vertical-align: middle; margin-right: 6px; }
    #treeCustomSorting .status-pill {
        padding: 5px 10px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 12px;
    }
    #treeCustomSorting .pill-started { background: #d4edda; color: #155724; }
    #treeCustomSorting .pill-open { background: #d1ecf1; color: #0c5460; }
    #treeCustomSorting .pill-instatus { background: #e2e3e5; color: #383d41; }
</style>

@code {
    private List<TaskData> TreeGridData { get; set; } = new();

    protected override void OnInitialized()
    {
        TreeGridData = TaskData.GetTree();
    }

    // Numeric sorting for string StoryPoints (ascending: 2 → 30)
    public class StoryPointsStringComparer : IComparer<object>
    {
        public int Compare(object? x, object? y)
        {
            var a = x as TaskData;
            var b = y as TaskData;

            bool aHasValue = int.TryParse(a?.StoryPoints ?? "", out int valA);
            bool bHasValue = int.TryParse(b?.StoryPoints ?? "", out int valB);

            if (!aHasValue && !bHasValue) return 0;
            if (!aHasValue) return -1; // Empty comes first
            if (!bHasValue) return 1;

            return valA.CompareTo(valB); // Ascending order
        }
    }

    public class PriorityComparer : IComparer<object>
    {
        private static readonly Dictionary<string, int> Order = new()
        {
            { "Low",      1 },
            { "Normal",   2 },
            { "High",     3 },
            { "Critical", 4 }
        };

        public int Compare(object? x, object? y)
        {
            var a = x as TaskData;
            var b = y as TaskData;

            int pa = Order.GetValueOrDefault(a?.Priority ?? "", 0);
            int pb = Order.GetValueOrDefault(b?.Priority ?? "", 0);

            // Ascending order: Low → Normal → High → Critical
            return pa.CompareTo(pb);
        }
    }
}