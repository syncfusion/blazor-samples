@page "/datagrid/expandoobject"

@using System.Dynamic
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.DropDowns
@using Syncfusion.Blazor.Buttons
@*Hidden:Lines*@
@inherits SampleBaseComponent
@inject NavigationManager NavigationManager


@*End:Hidden*@

<ActionDescription>
<p>This sample demonstrates how to use ExpandoObject data binding with comprehensive DataGrid features including CRUD operations, grouping, sorting, filtering, and aggregation.</p>
  
  <p>The Blazor DataGrid supports ExpandoObject data binding, providing dynamic schema flexibility. The <a target='_blank' href='https://help.syncfusion.com/cr/blazor/Syncfusion.Blazor.Grids.SfGrid-1.html#Syncfusion_Blazor_Grids_SfGrid_1_DataSource' aria-label="Navigate to the DataSource property reference for DataGrid component">DataSource</a> property accepts a list of ExpandoObject instances.</p>
  
  <p>The <a target='_blank' href='https://help.syncfusion.com/cr/blazor/Syncfusion.Blazor.Grids.GridColumn.html#Syncfusion_Blazor_Grids_GridColumn_Type' aria-label="Navigate to the Type property reference for Grid column">Type</a> property of the <a target='_blank' href='https://help.syncfusion.com/cr/blazor/Syncfusion.Blazor.Grids.GridColumn.html' aria-label="Navigate to the class reference for GridColumn">GridColumn</a> component allows you to define the <a target='_blank' href='https://help.syncfusion.com/cr/blazor/Syncfusion.Blazor.Grids.ColumnType.html' aria-label="Navigate to the class reference for ColumnType">ColumnType</a> based on the data type. In this demo, <code>Integer</code> and <code>Double</code> column types are configured for the <strong>OrderID</strong> and <strong>Freight</strong> columns.</p>
  
  <p>For more detailed information about ExpandoObject data binding, refer to the <a target='_blank' href='https://blazor.syncfusion.com/documentation/datagrid/data-binding#expandoobject-binding' aria-label="Navigate to the documentation for ExpandoObject binding in DataGrid component">ExpandoObject binding documentation</a>.</p>
</ActionDescription>


<div class="col-lg-12 control-section">
    <div class="content-wrapper">
        <div class="row">
            <SfGrid @ref="Grid" DataSource="@Orders" Height="400" AllowPaging="true" AllowGrouping="true" AllowFiltering="true" AllowSorting="true" Toolbar="@(new List<string>() { "Add", "Edit", "Delete", "Update", "Cancel" })">
                <GridEditSettings AllowAdding="true" AllowEditing="true" AllowDeleting="true" Mode="EditMode.Normal"></GridEditSettings>
                <GridGroupSettings ShowGroupedColumn="true"></GridGroupSettings>
                <GridAggregates>
                    <GridAggregate>
                        <GridAggregateColumns>
                            <GridAggregateColumn Field="Freight" Type="AggregateType.Sum" Format="C2">
                                <FooterTemplate>
                                    @{
                                        var aggregate = (context as AggregateTemplateContext);
                                        <div>
                                            <p>Sum: @aggregate?.Sum</p>
                                        </div>
                                    }
                                </FooterTemplate>
                            </GridAggregateColumn>
                            <GridAggregateColumn Field="Verified" Type="AggregateType.TrueCount">
                                <FooterTemplate>
                                    @{
                                        var aggregate = (context as AggregateTemplateContext);
                                        <div>
                                            <p>True Count: @aggregate?.TrueCount</p>
                                        </div>
                                    }
                                </FooterTemplate>
                            </GridAggregateColumn>
                        </GridAggregateColumns>
                    </GridAggregate>
                    <GridAggregate>
                        <GridAggregateColumns>
                            <GridAggregateColumn Field="Freight" Type="AggregateType.Average" Format="C2">
                                <FooterTemplate>
                                    @{
                                        var aggregate = (context as AggregateTemplateContext);
                                        <div>
                                            <p>Average: @aggregate?.Average</p>
                                        </div>
                                    }
                                </FooterTemplate>
                            </GridAggregateColumn>
                            <GridAggregateColumn Field="Verified" Type="AggregateType.FalseCount">
                                <FooterTemplate>
                                    @{
                                        var aggregate = (context as AggregateTemplateContext);
                                        <div>
                                            <p>False Count: @aggregate?.FalseCount</p>
                                        </div>
                                    }
                                </FooterTemplate>
                            </GridAggregateColumn>
                        </GridAggregateColumns>
                    </GridAggregate>
                </GridAggregates>
                <GridColumns>
                    <GridColumn Field="OrderID" HeaderText="Order ID" IsPrimaryKey="true" ValidationRules="@(new ValidationRules{ Required=true, Number=true})" Type="ColumnType.Integer" TextAlign="TextAlign.Right" Width="120"></GridColumn>
                    <GridColumn Field="CustomerID" HeaderText="Customer ID" Width="120" ValidationRules="@(new ValidationRules { Required=true})"></GridColumn>
                    <GridColumn Field="Freight" Format="C2" TextAlign="TextAlign.Right" AllowGrouping=false ValidationRules="@(new ValidationRules{ Required=true, Range = new object[]{1, 1000}})" Type="ColumnType.Double" Width="120"></GridColumn>
                    <GridColumn Field="OrderDate" HeaderText=" Order Date" ValidationRules="@(new ValidationRules{ Required=true})" Format="d" TextAlign="TextAlign.Right" Width="130" Type="ColumnType.Date"></GridColumn>
                    <GridColumn Field="ShipCountry" HeaderText="Ship Country" EditType="EditType.DropDownEdit" EditorSettings="@ShipCountryEditParams" Width="150"></GridColumn>
                    <GridColumn Field="Verified" HeaderText="Active" TextAlign="TextAlign.Center" Width="150" Type="ColumnType.Boolean">
                        <FilterTemplate>
                            @{
                                var FilterContext = (context as PredicateModel);
                                bool? fValue = string.IsNullOrEmpty(FilterContext?.Value.ToString()) ? null : (bool?)FilterContext.Value;
                            }
                            <SfCheckBox Checked="@fValue"  EnableTriState="true" ValueChange="OnValueChange" TChecked="bool?"></SfCheckBox>
                        </FilterTemplate>
                    </GridColumn>
                </GridColumns>
            </SfGrid>
        </div>
    </div>
</div>


@code {
    public SfGrid<ExpandoObject>? Grid { get; set; }
    public List<ExpandoObject> Orders { get; set; } = new List<ExpandoObject>();

    private List<string> DefaultShipCountrys = new List<string> { "USA", "UK" };
    private List<ExpandoObject> DropdownDataSource = new List<ExpandoObject>();


    private void InitializeDropdownDataSource()
    {
        DropdownDataSource = DefaultShipCountrys.Select(country =>
        {
            dynamic d = new ExpandoObject();
            d.ShipCountry = country;
            return d;
        }).Cast<ExpandoObject>().ToList();
    }

    public IEditorSettings ShipCountryEditParams => new DropDownEditCellParams
        {
            Params = new DropDownListModel<object, object>
            {
                DataSource = DropdownDataSource,
                Text = "ShipCountry",
                Value = "ShipCountry",
                PopupWidth = "100%"
            }
        };

    protected override void OnInitialized()
    {
        Orders = Enumerable.Range(1, 75).Select((x) =>
        {
            dynamic d = new ExpandoObject();
            d.OrderID = 1000 + x;
            d.CustomerID = x % 2 == 0 ? "ALFKI" : x % 5 == 0 ? "ANANTR" : x % 11 == 0 ? "ANTON" : "BOLID";
            d.Freight = Math.Round((2.3 * x), 2);
            d.OrderDate = x % 2 == 0 ? new DateTime(2010, 11, 5) : x % 5 == 0 ? new DateTime(2018, 10, 3) : x % 11 == 0 ? new DateTime(1995, 9, 9) : new DateTime(2012, 8, 2);
            d.ShipCountry = x % 3 == 0 ? "USA" : x % 2 == 0 ? "UK" : "USA";
            d.Verified = x % 3 == 0 ? true : false;
            return d;
        }).Cast<ExpandoObject>().ToList<ExpandoObject>();
        InitializeDropdownDataSource();

    }

    private async Task OnValueChange(ChangeEventArgs<bool?> args)
    {
        if (Grid != null)
        {
            if (args.Checked != null)
                await Grid.FilterByColumnAsync("Verified", "equal", args.Checked); //Perform filtering while check/uncheck the checkbox
            else
                await Grid.ClearFilteringAsync("Verified");
        }
    }
}
