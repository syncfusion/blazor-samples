@page "/gantt-chart/advanced-exporting"

@using Syncfusion.Blazor.Gantt
@using Syncfusion.Blazor.Navigations
@using Syncfusion.PdfExport
@using Syncfusion.Blazor.Grids
@using System.IO
@using System.Net
@using BlazorDemos.Pages.GanttChart.Data
@using Syncfusion.Blazor.Popups
@using Syncfusion.Blazor.Inputs
@using Syncfusion.Blazor.DropDowns
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.Calendars

@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager

@*Hidden:Lines*@
@inherits SampleBaseComponent
@inject SampleService SampleService
@implements IDisposable
@*End:Hidden*@

<ActionDescription>
	<p>
		This sample demonstrates the <strong>PDF export functionality</strong> of the <a class="e-gantt-advanceexporting-reference-link" aria-label="Navigate to the explore Syncfusion Blazor Gantt Chart component"
																  href="https://www.syncfusion.com/blazor-components/blazor-gantt-chart"
																  target="_blank" rel="noopener">Blazor Gantt Chart</a>.
		It allows exporting project schedules with customizable headers, footers, and taskbar rendering so reports align with corporate branding and compliance requirements.
		The export options include printing selected or all columns, exporting a specific timeline range, choosing single page or multi page modes, and configuring page orientation and paper size.
	</p>

	<p>
		The export workflow uses the
		<a class="e-gantt-advanceexporting-reference-link" aria-label="Navigate to the ExportToPdfAsync method reference for the Gantt chart component"
		   href="https://help.syncfusion.com/cr/blazor/Syncfusion.Blazor.Gantt.SfGantt-1.html#Syncfusion_Blazor_Gantt_SfGantt_1_ExportToPdfAsync_Syncfusion_Blazor_Gantt_GanttPdfExportProperties_"
		   target="_blank" rel="noopener">ExportToPdfAsync</a> method
		with <a class="e-gantt-advanceexporting-reference-link" aria-label="Navigate to the GanttPdfExportProperties for the Gantt chart component"
				  href="https://help.syncfusion.com/cr/blazor/Syncfusion.Blazor.Gantt.GanttPdfExportProperties.html"
			  target="_blank" rel="noopener">GanttPdfExportProperties</a> to fine tune layout and scaling.
		During generation, the
		<a class="e-gantt-advanceexporting-reference-link" aria-label="Navigate to the PdfQueryTaskbarInfo event reference"
		   href="https://help.syncfusion.com/cr/blazor/Syncfusion.Blazor.Gantt.GanttEvents-1.html#Syncfusion_Blazor_Gantt_GanttEvents_1_PdfQueryTaskbarInfo"
		   target="_blank" rel="noopener">PdfQueryTaskbarInfo</a>,
		event provides customization of taskbar graphics, colors, and annotations.
	</p>

	<p>
		These features ensure the exported Gantt Chart mirrors the interactive view including dependencies, progress, and resource allocation while offering flexible presentation control for both <strong>single page summaries</strong> and <strong>multi page reports with scaling support.</strong>
	</p>

	<p>
		For further details, refer to the
		<a class="e-gantt-advanceexporting-reference-link" aria-label="Navigate to the documentation for advanced exporting in the Gantt chart component"
		   href="https://blazor.syncfusion.com/documentation/gantt-chart/pdf-export"
		   target="_blank" rel="noopener">documentation</a>.
	</p>
</ActionDescription>

<div id="e-gantt-advanced-export-sample" class="control-section e-gantt-advanced-exporting-sample">
	<SfGantt @ref="@GanttChartRef" DataSource="@TaskCollection" EnableCriticalPath="true" AllowResizing="true" AllowPdfExport="true" AllowExcelExport="true" Width="100%" Height="700px" Toolbar="ToolbarItems"
			 ProjectStartDate="@(new DateTime(2025, 3, 25))" ProjectEndDate="@(new DateTime(2025, 5, 18))" ScrollToTaskbarOnClick="true">
		<GanttTaskFields Id="TaskId" Name="TaskName" StartDate="StartDate" EndDate="EndDate"
						 Duration="Duration" Progress="Progress" ParentID="ParentId" Dependency="Predecessor">
		</GanttTaskFields>
		<GanttEditSettings AllowEditing="false" AllowAdding="false" AllowTaskbarEditing="false" AllowSchedulingOnDrag="true" Mode="Syncfusion.Blazor.Gantt.EditMode.Dialog"></GanttEditSettings>
		<GanttSplitterSettings ColumnIndex="2"></GanttSplitterSettings>
		<GanttLabelSettings TValue="AdvancedExportingData.TaskData">
			<RightLabelTemplate>
				@{
					var taskData = context as AdvancedExportingData.TaskData;
					if (!string.IsNullOrEmpty(taskData?.ResourceName))
					{
						var resourceName = taskData.ResourceName.Trim().Replace(" ", "").ToLower();
						<div class="e-right-label-inner-div">
							<img class="e-label image" role="presentation"
								 src="@NavigationManager.ToAbsoluteUri($"{SampleService.WebAssetsPath}images/gantt/{resourceName}.png")" alt="@resourceName" />

						</div>
					}
				}
			</RightLabelTemplate>
			<LeftLabelTemplate>
				@{
					var taskItem = context as AdvancedExportingData.TaskData;
					if (taskItem.TaskId != 7)
					{
						<div class="e-left-label-inner-div" style="color:#1A3A5E;">
							<span class="e-label">@taskItem.TaskName</span>
						</div>
					}
					else
					{
						<div class="e-left-label-inner-div" style="color:#8E2440">
							<span class="e-label">Custom Label</span>
						</div>
					}
				}

			</LeftLabelTemplate>
		</GanttLabelSettings>
		<GanttColumns>
			<GanttColumn Field="TaskId" HeaderText="Id"></GanttColumn>
			<GanttColumn Field="TaskName" HeaderText="Name" Width="250"></GanttColumn>
			<GanttColumn Field="StartDate" HeaderText="Start Date" Width="100"></GanttColumn>
			<GanttColumn Field="EndDate" HeaderText="End Date" Width="90px"></GanttColumn>
			<GanttColumn Field="Duration" HeaderText="Duration" Width="100"></GanttColumn>
			<GanttColumn Field="Progress" HeaderText="Progress" Width="100"></GanttColumn>
			<GanttColumn Field="Predecessor" HeaderText="Dependency" Width="105px"></GanttColumn>
		</GanttColumns>
		<GanttEventMarkers>
			<GanttEventMarker Day="new DateTime(2025, 04, 11)" Label="Branding product"
							  CssClass="e-custom-event-marker"></GanttEventMarker>
		</GanttEventMarkers>
		<GanttEvents OnToolbarClick="ToolbarClickHandler" PdfQueryTaskbarInfo="PdfQueryTaskbarInfoHandler" QueryChartRowInfo="QueryChartRowInfo" PdfExporting="PdfExportingHandler" TValue=AdvancedExportingData.TaskData></GanttEvents>
		<GanttCriticalPathSettings SlackValue="5"></GanttCriticalPathSettings>
	</SfGantt>
</div>
<div>
    @if (OpenDialog) 
    {
        <SfDialog @ref="DialogObj" ID="pdf-dialog"  class="e-pdf-dialog" Target="#e-gantt-advanced-export-sample"
        AllowDragging="true" ShowCloseIcon="true" IsModal="true" CloseOnEscape="true" Height="@height" @bind-Visible="@IsVisible">
            <DialogPositionData X="@dialogPosition" Y="@dialogPosition"></DialogPositionData>
            <DialogAnimationSettings Effect="DialogEffect.None"></DialogAnimationSettings>
            <DialogTemplates>
                <Header>
                    Export Settings
                </Header>
                <Content>
                    <div class="row">

                        <div class="d-block e-margin-bottom-3 e-padding-0">
                            <SfMultiSelect TValue="List<string>" TItem="string"
                                            Mode="VisualMode.Default"
                                            DataSource="@ColumnOptions"
											Placeholder="Columns"
                                            @bind-Value="SelectedColumns" FloatLabelType="FloatLabelType.Always">
                            </SfMultiSelect>
                        </div>
                        
                        <div class="d-block e-margin-bottom-3 e-padding-0">
							<SfDropDownList TValue="string" TItem="string"
											Placeholder="Timeline Range"
											DataSource="@TimelineOptions" FloatLabelType="FloatLabelType.Always"
											@bind-Value="TimelineSelection">
							</SfDropDownList>
                        </div>

                        @if (TimelineSelection == "Range")
                        {
                            <div class="d-block e-margin-bottom-3 e-padding-0">
								<SfDateRangePicker TValue="DateTime?" @bind-EndDate="@TimelineEnd" @bind-StartDate="@TimelineStart" Min="@ProjectStartDate" Max="@ProjectEndDate" Placeholder="Date Range"
                                         FloatLabelType="FloatLabelType.Always" Format="MM/dd/yyyy" Separator=" - " ShowClearButton="true">
                                    <DateRangePickerEvents TValue="DateTime?" ValueChange="OnTimelineRangeChanged"></DateRangePickerEvents>
                                </SfDateRangePicker>
                            </div>
                        }

                        <div class="d-block e-margin-bottom-3 e-padding-0">
							<SfDropDownList TValue="string" TItem="string"
											Placeholder="Export Type" FloatLabelType="FloatLabelType.Always"
											DataSource="@ExportTypeOptions"
											@bind-Value="SelectedExportType">
							</SfDropDownList>
                        </div>

						@if (SelectedExportType == "Multiple Page")
                        {
                            <div class="d-block e-margin-bottom-3 e-padding-0">
                                <SfNumericTextBox TValue="int" @bind-Value="ScalePercentage"
                                                    Min="10" Max="400" Step="5"
													Placeholder="Adjust To (%)"
                                                    ShowSpinButton="true" FloatLabelType="FloatLabelType.Always">
                                </SfNumericTextBox>
                            </div>
                        }
						<div class="d-block e-margin-bottom-3 e-padding-0">
							<SfDropDownList TValue="PageOrientation" TItem="PageOrientation"
											Placeholder="Orientation"
											DataSource="@OrientationOptions" FloatLabelType="FloatLabelType.Always"
											@bind-Value="SelectedOrientation">
							</SfDropDownList>
						</div>
						<div class="d-block e-margin-bottom-3 e-padding-0">
							<SfDropDownList TValue="Syncfusion.Blazor.Grids.PdfPageSize" TItem="Syncfusion.Blazor.Grids.PdfPageSize"
											Placeholder="Paper Size" FloatLabelType="FloatLabelType.Always"
											DataSource="@PaperSizeOptions"
											@bind-Value="SelectedPaperSize">
							</SfDropDownList>
						</div>
                    </div>
                </Content>
        </DialogTemplates>
        <DialogButtons>
            <DialogButton OnClick="@OnSaveClick" Disabled="IsSaveButtonClicked" Content="Export" CssClass="e-primary">
            </DialogButton>
            <DialogButton OnClick="@OnCancelClick" Content="Cancel" CssClass="e-flat">
            </DialogButton>
        </DialogButtons>
        </SfDialog>
    }
</div>
@code{

	/// <summary>
	/// Initializes the Gantt chart with task data and loads resource images for PDF export.
	/// </summary>
	protected override async Task OnInitializedAsync()
	{
		TaskCollection = AdvancedExportingData.GetTaskCollection();
		var resourceNames = TaskCollection
		.Where(task => !string.IsNullOrEmpty(task.ResourceName))  // Exclude empty/null values
		.Select(task => task.ResourceName.Trim().Replace(" ", "").ToLower())  // Normalize names
		.Distinct() // Ensure uniqueness
		.ToList();

		foreach (var resourceName in resourceNames)
		{
			var filePath = NavigationManager.ToAbsoluteUri($"{SampleService.WebAssetsPath}images/gantt/{resourceName}.png").ToString();

			try
			{
				var base64String = await JSRuntime.InvokeAsync<string>("convertGanttImageBaseUrl", filePath);
				if (!string.IsNullOrEmpty(base64String))
				{
					pdfExportImage[resourceName] = base64String;
				}
			}
			catch (Exception ex)
			{
				Console.WriteLine($"Error loading image {resourceName}: {ex.Message}");
			}
		}
		@*Hidden:Lines*@
		SampleService.TouchMousePreferenceChanged += OnTouchMousePreferenceChanged;
		@*End:Hidden*@
		await Task.CompletedTask;
	}

	@*Hidden:Lines*@
	private async void OnTouchMousePreferenceChanged()
	{
		await GanttChartRef.RefreshAsync();
		await GanttChartRef.CallStateHasChangedAsync();
	}

	public void Dispose()
	{
		SampleService.TouchMousePreferenceChanged -= OnTouchMousePreferenceChanged;
	}
	@*End:Hidden*@
}

<style>
	.container-fluid {
		padding: 0px !important;
	}

	.e-gantt-advanced-exporting-sample .taskbar-critical .e-gantt-child-taskbar {
		background: #FFCEF4 !important;
		outline: 1px solid #FFCEF4 !important;
	}

	.e-gantt-advanced-exporting-sample .progress-critical .e-gantt-child-progressbar {
		background: #B0008A !important;
	}

	.e-gantt-advanced-exporting-sample .taskbar-critical-dark .e-gantt-child-taskbar {
		background: #49043A !important;
		outline: 1px solid #49043A !important;
	}

	.e-gantt-advanced-exporting-sample .progress-critical-dark .e-gantt-child-progressbar {
		background: #AC0688 !important;
	}
	.e-pdf-dialog {
		padding: 24px !important;	
	}
	.e-dialog .e-dlg-header-content {
		padding: 0px 7px !important;
		padding-bottom: 10px !important;
	}

	.e-pdf-dialog {
		width: 40% !important;
	}
	.e-pdf-dialog .e-footer-content{
		padding: 0px 10px !important;
	}
	@@media (max-width: 992px) {
		.e-pdf-dialog {
			width: 60% !important;
		}
		.e-padding-left-3 {
			padding-left: 0px !important;
		}
	}

	@@media (max-width: 768px) {
		.e-pdf-dialog {
			padding: 24px 16px !important;
			width: 80% !important;
		}

		.e-pdf-dialog .e-footer-content {
			padding: 7px !important;
		}

		.e-pdf-dialog .e-footer-content button {
			width: 100%;
			margin: 0 !important;
		}

		.e-pdf-dialog .e-footer-content button.e-primary {
			margin-bottom: 11px !important;
		}
	}
</style>
