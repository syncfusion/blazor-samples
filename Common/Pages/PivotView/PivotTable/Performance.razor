@page "/pivot-table/performance"

@using Syncfusion.Blazor.PivotView
@using Syncfusion.Blazor.DropDowns
@using Syncfusion.Blazor.Spinner
@using System.Diagnostics

@*Hidden:Lines*@
@inherits SampleBaseComponent;
@*End:Hidden*@

<ActionDescription>
<p>This sample demonstrates efficient pivot table performance when handling large datasets through virtual scrolling optimization.</p>
    
    <p>Virtual scrolling maximizes performance by:</p>
    
    <ul>
        <li>Rendering only visible viewport rows and columns</li>
        <li>Loading data dynamically as users scroll</li>
        <li>Supporting million-row datasets with optimized efficiency</li>
        <li>Enabling seamless navigation through large data collections</li>
    </ul>
    
    <p>Enable virtualization using the <a target="_blank" rel="noopener" href="https://help.syncfusion.com/cr/blazor/Syncfusion.Blazor.PivotView.SfPivotView-1.html#Syncfusion_Blazor_PivotView_SfPivotView_1_EnableVirtualization" aria-label="Class reference of EnableVirtualization property in PivotView">EnableVirtualization</a> property. Select different row counts from the dropdown to observe performance across varying dataset sizes.</p>
    
    <p>For comprehensive virtual scrolling documentation, refer to the <a target="_blank" rel="noopener" href="https://blazor.syncfusion.com/documentation/pivot-table/virtual-scrolling" aria-label="Blazor PivotTable Virtualization documentation">virtualization documentation</a>.</p>
</ActionDescription>


<div class="control-section">
    <div class="content-wrapper">
        <div class="row">
            <div class="e-dddata">
                <div class="dropdown-wrapper">
                    <SfDropDownList TItem="DDData" TValue="string" PopupHeight="230px" Width="240px" @bind-Index="@_index" DataSource="@DLData">
                        <DropDownListEvents TItem="DDData" TValue="string" ValueChange="OnChange" Closed="DropdownClose"></DropDownListEvents>
                        <DropDownListFieldSettings Text="Text" Value="Value"></DropDownListFieldSettings>
                    </SfDropDownList>
                    <SfSpinner @ref="_spinnerObj"></SfSpinner>
                </div>
                <div id="performance" style="float:right;padding:5px">
                    Time taken = @_timeElapsed
                </div>
            </div>

            <div id="Pivot" style="padding:0 10px" class="@(_isLoading ? "disabled" : "")">
                <SfPivotView TValue="PivotLargeData" Width="100%" Height="300" EnableVirtualization="true" ShowTooltip=false>
                    <PivotViewDataSourceSettings TValue="PivotLargeData" DataSource="Data" EnableSorting="false" DataSourceChanged="@DataSourceChanged">
                        <PivotViewColumns>
                            <PivotViewColumn Name="Year"></PivotViewColumn>
                        </PivotViewColumns>
                        <PivotViewRows>
                            <PivotViewRow Name="ProductID"></PivotViewRow>
                        </PivotViewRows>
                        <PivotViewValues>
                            <PivotViewValue Name="Price" Caption="Unit Price"></PivotViewValue>
                            <PivotViewValue Name="Sold" Caption="Unit Sold"></PivotViewValue>
                        </PivotViewValues>
                        <PivotViewFormatSettings>
                            <PivotViewFormatSetting Name="Price" Format="C0"></PivotViewFormatSetting>
                            <PivotViewFormatSetting Name="Sold" Format="N0"></PivotViewFormatSetting>
                        </PivotViewFormatSettings>
                        <PivotViewSortSettings>
                            <PivotViewSortSetting Name="Year" Order="Sorting.Ascending"></PivotViewSortSetting>
                            <PivotViewSortSetting Name="ProductID" Order="Sorting.Ascending"></PivotViewSortSetting>
                        </PivotViewSortSettings>
                    </PivotViewDataSourceSettings>
                    <PivotViewGridSettings ColumnWidth="120"></PivotViewGridSettings>
                    <PivotViewEvents TValue="PivotLargeData" OnLoad="OnLoad" DataBound="@DataBound"></PivotViewEvents>
                </SfPivotView>
            </div>
        </div>
    </div>
</div>

<style>
    .e-pivotview {
        min-height: 200px;
    }

    .e-dddata {
        margin: 0 10px 15px 10px;
    }

    .e-pivotview .e-pivot-content-loader {
        pointer-events: none;
    }

    .dropdown-wrapper {
        position: relative;
        display: inline-block;
    }

    #Pivot.disabled {
        pointer-events: none;
        opacity: 0.5;
    }

    @@media only screen and (max-width: 450px) {
        #performance {
            float: revert !important;
        }
    }
</style>

@code {

    private List<PivotLargeData>? Data { get; set; }
    private SfSpinner? _spinnerObj;
    private bool _disableButton = false;
    private bool _isLoading = false;
    private Stopwatch _stopWatch = new Stopwatch();
    private string _timeElapsed = "0 sec";
    private int? _index { get; set; } = 0;
    private int? _previousIndex { get; set; } = 0;
    public int Value { get; set; } = 1000;
    protected override void OnInitialized()
    {
        //Hidden:Lines
        _stopWatch.Start();
        Data = PivotLargeData.GetLargeData(1000);
        //End:Hidden
    }
    private void DropdownClose(@Syncfusion.Blazor.DropDowns.ClosedEventArgs args)
    {
        if (_previousIndex != _index)
        {
            Data = PivotLargeData.GetLargeData(Value);
            _previousIndex = _index;
        }
    }
    public async Task OnChange(@Syncfusion.Blazor.DropDowns.ChangeEventArgs<string, DDData> args)
    {
        if (_previousIndex != _index && _spinnerObj != null)
        {
            _isLoading = true;
            await _spinnerObj.ShowAsync();
        }
        Value = Int32.Parse(args.Value);
    }
    private void OnLoad(LoadEventArgs<PivotLargeData> args)
    {
        _stopWatch.Reset();
        _stopWatch.Start();
    }
    private void DataSourceChanged()
    {
        _stopWatch.Reset();
        _stopWatch.Start();
    }
    private async Task DataBound()
    {
        _stopWatch.Stop();
        TimeSpan TimeTaken = _stopWatch.Elapsed;
        _timeElapsed = String.Format("{0:00}:{1:00} seconds", TimeTaken.Seconds, TimeTaken.Milliseconds / 100);
        _isLoading = false;
        if(_spinnerObj != null)
        {
            await _spinnerObj.HideAsync();
        }
    }
    public class DDData
    {
        public string Text { get; set; } = string.Empty;
        public string Value { get; set; } = string.Empty;
    }

    public List<DDData> DLData = new List<DDData>() 
    {
        new DDData() { Text = "1,000 Rows and 10 Columns", Value = "1000" },
        new DDData() { Text = "10,000 Rows and 10 Columns", Value = "10000" },
        new DDData() { Text = "100,000 Rows and 10 Columns", Value = "100000" },
    };
}
