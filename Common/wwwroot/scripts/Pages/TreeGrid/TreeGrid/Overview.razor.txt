@page "/tree-grid/overview"
@using Syncfusion.Blazor.TreeGrid
@using Syncfusion.Blazor.Grids
@using System.Linq
@using BlazorDemos.Pages.TreeGrid
@inject Microsoft.AspNetCore.Components.NavigationManager UriHelper
@*Hidden:Lines*@
@inherits SampleBaseComponent
@*End:Hidden*@



<ActionDescription>
<p>
    This sample provides an overview of the Tree Grid, showcasing hierarchical data in a high-performance tabular view.
  </p>
  <p>
    Hierarchical data is bound using <code>IdMapping</code> and <code>ParentIdMapping</code>. Row virtualization (<a target="_blank" rel="noopener" href="https://help.syncfusion.com/cr/blazor/Syncfusion.Blazor.TreeGrid.SfTreeGrid-1.html#Syncfusion_Blazor_TreeGrid_SfTreeGrid_1_EnableVirtualization">EnableVirtualization</a>) renders only visible rows for performance.
  </p>
  <p>
    Additional features include <a target="_blank" rel="noopener" href="https://blazor.syncfusion.com/documentation/treegrid/filtering/filtering">filtering</a>, <a target="_blank" rel="noopener" href="https://blazor.syncfusion.com/documentation/treegrid/sorting">sorting</a>, and <a target="_blank" rel="noopener" href="https://blazor.syncfusion.com/documentation/treegrid/searching">searching</a>. Column templates display avatars, role badges, mail links, flags, status indicators, project chips, and a progress bar.
  </p>
  <p>
    Learn more in the <a target="_blank" rel="noopener" href="https://blazor.syncfusion.com/documentation/treegrid/getting-started">getting started documentation</a>.
  </p>
</ActionDescription>





<SfTreeGrid TValue="EmployeeNode"
            DataSource="@Employees"
            IdMapping="CommonId"
            ParentIdMapping="ParentCommonId"
            TreeColumnIndex="2"
            AllowFiltering="true"
            AllowSorting="true"
            Height="560px"
            Toolbar="@(new List<string>() { "Search" })">
    <TreeGridFilterSettings Type="Syncfusion.Blazor.TreeGrid.FilterType.Excel"></TreeGridFilterSettings>
    <TreeGridColumns>
        <TreeGridColumn Field="@nameof(EmployeeNode.CommonId)" HeaderText="Common ID" IsPrimaryKey="true" Width="115" TextAlign="TextAlign.Right" ClipMode="ClipMode.EllipsisWithTooltip" Visible="false" />
        <TreeGridColumn Field="@nameof(EmployeeNode.EmployeeId)" HeaderText="Employee ID" Width="130" TextAlign="TextAlign.Right" ClipMode="ClipMode.EllipsisWithTooltip" />
        <TreeGridColumn Field="@nameof(EmployeeNode.Name)" HeaderText="Employee Name" Width="360" Freeze="FreezeDirection.Left">
            <Template>
                @{
                    var e = (context as EmployeeNode)!;
                    var initials = Initials(e.Name);
                    var (bg, fg, brd) = InitialsColor(e.Name);
                }
                <div style="display:flex;align-items:center;gap:10px;">
                    <div class="avatar-initial" style="background:@bg;color:@fg;border-color:@brd;" aria-hidden="true">@initials</div>
                    <div class="name-cell">
                        <span class="name-strong">@e.Name</span>
                        <span class="muted">@e.Designation</span>
                    </div>
                </div>
            </Template>
        </TreeGridColumn>
        <TreeGridColumn Field="@nameof(EmployeeNode.Gender)" HeaderText="Gender" Width="110" TextAlign="TextAlign.Center" Visible="false" />
        <TreeGridColumn Field="@nameof(EmployeeNode.Department)" HeaderText="Department" Width="180" />
        <TreeGridColumn Field="@nameof(EmployeeNode.Role)" HeaderText="Role" Width="280">
            <Template>
                @{
                    var e = (context as EmployeeNode)!;
                    var (bg, fg, brd) = RoleChipStyle(e.Role);
                }
                <span class="role-chip" style="background:@bg;color:@fg;border-color:@brd;">@e.Role</span>
            </Template>
        </TreeGridColumn>
        <TreeGridColumn Field="@nameof(EmployeeNode.Email)" HeaderText="Email Address" Width="260">
            <Template>
                @{
                    var e = (context as EmployeeNode)!;
                }
                <a href="mailto:@e.Email" class="link" onclick="event.preventDefault();">@e.Email</a>
            </Template>
        </TreeGridColumn>
        <TreeGridColumn Field="@nameof(EmployeeNode.Branch)" HeaderText="Branch" Width="220">
            <Template>
                @{
                    var e = (context as EmployeeNode)!;
                    var (code, country) = BranchCountry(e.Branch);
                    var imageFileName = WebpFiles.Contains(country) ? $"{country.ToLower().Replace(" ", "-")}.webp" : $"{country.ToLower().Replace(" ", "-")}.png";
                    var flag = UriHelper.ToAbsoluteUri($"{SampleService?.WebAssetsPath}images/tree-grid/country/{imageFileName}");
                    var flagUrl = string.IsNullOrWhiteSpace(code) ? null : flag.ToString();
                }
                <div style="display:flex;align-items:center;gap:8px;">
                    @if (!string.IsNullOrWhiteSpace(flagUrl))
                    {
                        <img class="flag" src="@flagUrl" alt="@country flag" title="@country" />
                    }
                    <span style="font-size:inherit">@e.Branch</span>
                </div>
            </Template>
        </TreeGridColumn>
        <TreeGridColumn Field="@nameof(EmployeeNode.WorkingStatus)" HeaderText="Working Status" Width="220" AllowFiltering="true">
            <Template>
                @{
                    var e = (context as EmployeeNode)!;
                    var (status, where) = ParseWorkingStatus(e.WorkingStatus);
                    var (bg, fg, dot) = WorkingStatusBadgeColors(status);
                }
                <div class="status-badge" style="background:@bg;color:@fg;" title="@e.WorkingStatus">
                    <span class="status-dot" style="background:@dot;"></span>
                    <div class="status-text">
                        <span class="status-main">@status</span>
                        @if (!string.IsNullOrWhiteSpace(where))
                        {
                            <span class="status-sub">@where</span>
                        }
                    </div>
                </div>
            </Template>
        </TreeGridColumn>
        <TreeGridColumn Field="@nameof(EmployeeNode.DateJoined)" HeaderText="Joined Date" Type="ColumnType.Date" Format="d" Width="110" ClipMode="ClipMode.EllipsisWithTooltip" />
        <TreeGridColumn Field="@nameof(EmployeeNode.ProjectsCsv)" HeaderText="Projects" Width="300" AllowFiltering="false">
            <Template>
                @{
                    var e = (context as EmployeeNode)!;
                }
                <div class="proj-scroll">
                    @foreach (var p in e.Projects)
                    {
                        <span class="proj-pill" title="@p">@p</span>
                    }
                </div>
            </Template>
        </TreeGridColumn>
        <!-- Achievement Progress (unchanged) -->
        <TreeGridColumn Field="@nameof(EmployeeNode.AchievementPoints)" HeaderText="Achievement Progress" Width="420" AllowFiltering="false">
            <Template>
                @{
                    var e2 = (context as EmployeeNode)!;
                    var tier = GetTier(e2.AchievementPoints);
                    var next = NextThreshold(tier);
                    var pct = next == null ? 100 : Math.Round(100.0 * (e2.AchievementPoints - tier.Min) / (next.Value - tier.Min), 2);
                    var needed = next == null ? 0 : Math.Max(0, next.Value - e2.AchievementPoints);
                    var (c1, c2) = TierGradient(tier.Name);
                }
                <div class="ach-wrap">
                    <div class="medal-box" aria-hidden="true">
                        @{
                            var medalName = tier.Name.ToLower().Trim('+');
                            var medalImage = medalName + ".png";
                            var url = UriHelper.ToAbsoluteUri($"{SampleService?.WebAssetsPath}images/tree-grid/overview/{medalImage}");
                            <img src="@url" alt="@tier.Name medal" title="@tier.Name" />
                        }
                    </div>
                    <div class="ach-right">
                        <div class="ach-title">@tier.Name Medal</div>
                        <div class="ach-sub" title="@($"{needed} points needed for {(next is null ? tier.Name : TierName(next.Value))} ({pct}% completed).")">
                            @if (next is null)
                            {
                                <text>Max tier reached. 100% completed.</text>
                            }
                            else
                            {
                                <text>@needed points needed for @TierName(next.Value) (@pct% completed).</text>
                            }
                        </div>
                        <div class="ach-bar">
                            <div class="ach-bar-fill" style="width:@pct%;background:linear-gradient(90deg,@c1,@c2)"></div>
                            <div class="ach-bar-stripes"></div>
                        </div>
                        <div class="ach-footer">
                            <span>@e2.AchievementPoints</span>
                            <span>@(next is null ? $"{tier.Max} max" : $"{next.Value} target")</span>
                        </div>
                    </div>
                </div>
            </Template>
        </TreeGridColumn>
        <!-- Badges (always visible; no external images) -->
        <TreeGridColumn HeaderText="Badges" Width="340" AllowFiltering="false">
            <Template>
                @{
                    var e = (context as EmployeeNode)!;
                    const int maxInline = 6;
                    // Prefer existing badges; otherwise derive deterministic set from points/id
                    List<string> source =
                        (e.Badges != null && e.Badges.Count > 0)
                        ? e.Badges
                        : DeriveBadges(e);
                    var normalized = source.Where(b => AllowedBadges.Contains(b)).ToList();
                    var shown = normalized.Take(maxInline).ToList();
                    var remaining = normalized.Count - shown.Count;
                }
                <div class="badge-row">
                    @foreach (var badge in shown)
                    {
                        <span class="badge-emoji" style="@BadgeStyle(badge)" title="@badge">
                            @if (AllowedBadges.Contains(badge))
                            {
                                var badgeName = badge.ToString().ToLower().Replace(" ", "");
                                var badgeImage = badgeName + ".png";
                                var url = UriHelper.ToAbsoluteUri($"{SampleService?.WebAssetsPath}images/tree-grid/overview/{badgeImage}");
                                <img src="@url" alt="@badge badge" title="@badge" />
                            }
                        </span>
                    }
                    @if (remaining > 0)
                    {
                        <span class="badge-more">+@remaining</span>
                    }
                </div>
            </Template>
        </TreeGridColumn>
    </TreeGridColumns>
</SfTreeGrid>

<style>
/* Shared */
.avatar-initial {
    height: 36px;
    width: 36px;
    border-radius: 50%;
    border: 1px solid #e5e7eb;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: inherit;
    letter-spacing: .5px;
}
.name-cell {
    display: flex;
    flex-direction: column;
    line-height: 1.15;
}
.name-strong {
    font-weight: inherit;
}
.muted {
    font-size: inherit;
    color: #6b7280;
    line-height: 1.35;
}
.link {
    color: #0ea5e9;
    text-decoration: none;
}
.link:hover {
    text-decoration: underline;
}
.flag {
    width: 32px;
    height: 22px;
    border: 1px solid #e5e7eb;
    border-radius: 2px;
    object-fit: cover;
}
/* Role chip */
.role-chip {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 4px 12px;
    min-height: 24px;
    line-height: 20px;
    border-radius: 9999px;
    border: 1px solid transparent;
    box-shadow: 0 1px 0 rgba(0,0,0,.06);
    font-weight: inherit;
    letter-spacing: .1px;
    white-space: nowrap;
}
/* Working status badge */
.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 10px;
    border-radius: 10px;
    border: 1px solid rgba(0,0,0,0.05);
}
.status-dot {
    width: 10px;
    height: 10px;
    border-radius: 9999px;
    flex: none;
}
.status-text {
    display: flex;
    flex-direction: column;
    line-height: 1.1;
}
.status-main {
    font-weight: inherit;
    font-size: inherit;
}
.status-sub {
    font-size: inherit;
    opacity: .85;
}
/* Projects pills: UPDATED to remove horizontal scrolling and allow wrapping */
.proj-scroll {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    max-width: 100%;
    overflow: visible;
    white-space: normal;
}
.proj-pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 2px 8px;
    border-radius: 9999px;
    background: #eef2ff !important;
    color: #3730a3 !important;
    border: 1px solid rgba(55,48,163,.15) !important;
    font-size: inherit;
    line-height: 18px;
    white-space: nowrap;
}
/* Achievement progress */
.ach-wrap {
    display: flex;
    align-items: center;
    gap: 12px;
    width: 100%;
}
.medal-box {
    width: 34px;
    height: 34px;
    flex: none;
    display: flex;
    align-items: center;
    justify-content: center;
}
.medal-box svg, .medal-box img {
    width: 34px;
    height: 34px;
    display: block;
}
.ach-right {
    flex: 1 1 auto;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: 6px;
}
.ach-title {
    font-weight: inherit;
    font-size: inherit;
    line-height: 1.1;
    color: #111827;
    margin: 0;
}
.ach-sub {
    color: #6b7280;
    font-size: inherit;
    line-height: 16px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin: 0;
}
.ach-bar {
    position: relative;
    width: 100%;
    height: 12px;
    border-radius: 9999px;
    background: #eef2f7 !important;
    overflow: hidden;
    isolation: isolate;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.04);
}
.ach-bar-fill {
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    z-index: 1;
    border-top-left-radius: 9999px;
    border-bottom-left-radius: 9999px;
}
.ach-bar-stripes {
    position: absolute;
    inset: 0;
    z-index: 2;
    pointer-events: none;
    opacity: .30;
    background-image: repeating-linear-gradient(45deg,rgba(0,0,0,.25) 0,rgba(0,0,0,.25) 10px,transparent 10px,transparent 20px);
    mix-blend-mode: multiply;
}
.ach-footer {
    display: flex;
    justify-content: space-between;
    font-size: inherit;
    color: #374151;
    margin: 0;
}
/* Badges */
.badge-row {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-wrap: nowrap;
    overflow: hidden;
}
.badge-emoji {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    line-height: 1;
    border: 1px solid #d1d5db;
    user-select: none;
}
.badge-emoji img {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    line-height: 1;
    border: 1px solid #d1d5db;
    user-select: none;
}
.badge-more {
    font-size: inherit;
    color: #374151;
    padding: 2px 6px;
    border-radius: 10px;
    background: #f3f4f6;
}
/* Images in cells */
img {
    max-width: 100%;
    height: auto;
}
.bootstrap5-dark .muted,
.bootstrap5\.3-dark .muted,
.tailwind-dark .muted,
.tailwind3-dark .muted,
.fluent-dark .muted,
.fluent2-highcontrast .muted,
.fluent2-dark .muted,
.material3-dark .muted {
    color: #fff;
}
.bootstrap5-dark .ach-title,
.bootstrap5\.3-dark .ach-title,
.tailwind-dark .ach-title,
.tailwind3-dark .ach-title,
.fluent-dark .ach-title,
.fluent2-highcontrast .ach-title,
.fluent2-dark .ach-title,
.material3-dark .ach-title {
    color: #fff;
}
.bootstrap5-dark .ach-sub,
.bootstrap5\.3-dark .ach-sub,
.tailwind-dark .ach-sub,
.tailwind3-dark .ach-sub,
.fluent-dark .ach-sub,
.fluent2-highcontrast .ach-sub,
.fluent2-dark .ach-sub,
.material3-dark .ach-sub {
    color: #fff;
}
.bootstrap5-dark .ach-footer,
.bootstrap5\.3-dark .ach-footer,
.tailwind-dark .ach-footer,
.tailwind3-dark .ach-footer,
.fluent-dark .ach-footer,
.fluent2-highcontrast .ach-footer,
.fluent2-dark .ach-footer,
.material3-dark .ach-footer {
    color: #fff;
}
</style>

@code {
    private List<object> ToolbarItems = new() { "Search", "ExcelExport", "PdfExport", "CsvExport", "Print", "ColumnChooser" };
    private List<EmployeeNode> Employees = new();
    // grandchildren per child (gc loop count)
    private const int pageCount = 10;

    // Project pool: SHORT NAMES ONLY (as requested)
    private static readonly string[] ProjectsPool = new[]
    {
        "EnterpriseHub",
	    "ConnectSphere",
	    "InsightLayer",
	    "WorkflowOne",
	    "DataBridge",
	    "SecurePath",
	    "AnalyticsPro",
	    "PlatformX",
	    "ControlTower",
	    "UnityEngine"
    };

    protected override Task OnInitializedAsync()
    {
        Employees = BuildHierarchicalDataInline();
        return Task.CompletedTask;
    }

    public List<string> WebpFiles { get; set; } = new List<string>
    {
        "Brazil", "Bulgaria", "Chile", "Colombia", "Croatia", "England",
        "Hungary", "Italy", "Poland", "Qatar", "Russia", "South Africa", "Spain", "Sweden", "Uruguay"
    };

    private List<EmployeeNode> BuildHierarchicalDataInline()
    {
        var list = new List<EmployeeNode>();
        var rnd = new Random(1234);

        var rootNames = new[]
        {
            "Avery Morgan", "Taylor Smith", "Jordan Johnson", "Casey Williams", "Riley Brown",
            "Drew Jones", "Quinn Davis", "Hayden Miller", "Parker Wilson", "Alex Taylor"
        };
        var branches = new[]
        {
            "United States","Brazil", "Bulgaria", "Chile", "Colombia", "Croatia", "England",
            "Hungary", "Italy", "Poland", "Qatar", "Russia", "South Africa", "Spain", "Sweden", "Uruguay"
        };
        var departments = new[] { "Engineering", "Platform", "Security", "Data", "QA" };
        var roles = new[]
        {
            "Director of Engineering","Engineering Manager","Senior Software Engineer","Software Engineer","Front End Engineer",
            "Back End Engineer","Full Stack Engineer","Site Reliability Engineer","DevOps Engineer","Data Engineer"
        };
        var TopRoles = new[]
        {
            "VP of Engineering",
            "Head of Engineering",
            "Director of Software Engineering",
            "Director of Platform Engineering"
        };

        int commonSeq = 1;
        int employeeSeq = 1000;

        EmployeeNode AddEmployee(string name, int? managerEmpId, int? parentCommonId, string role, string dept, string branch)
        {
            var e = new EmployeeNode
            {
                EmployeeId = employeeSeq++,
                ManagerId = managerEmpId,
                HasReports = false,
                Name = name,
                Gender = (name.Split(' ')[0].Length % 2 == 0) ? "Male" : "Female",
                Email = $"{name.Replace(" ", ".").ToLowerInvariant()}{employeeSeq}@example.com",
                Designation = role,
                Role = role,
                Department = dept,
                Branch = branch,
                WorkingStatus = managerEmpId is null ? "Available" : PickWorkingStatus(rnd, branch),
                TotalLeaveCount = rnd.Next(0, 6),
                DateJoined = DateTime.UtcNow.Date.AddDays(-rnd.Next(2000)),
                PhotoUrl = "",
                Projects = new List<string>(),
                AchievementPoints = rnd.Next(100, 1500),
                Badges = new List<string>(),
                CommonId = commonSeq++,
                ParentCommonId = parentCommonId
            };
            // UPDATED: Root parents get Platinum/Diamond achievement and all badges
            if (managerEmpId is null)
            {
                bool diamond = rnd.Next(2) == 0; // 50/50 Diamond or Platinum
                e.AchievementPoints = diamond ? rnd.Next(1500, 2001) : rnd.Next(1250, 1500);
                e.Badges = AllowedBadges.ToList();
            }
            list.Add(e);
            return e;
        }

        for (int r = 0; r < rootNames.Length; r++)
        {
            var rootRole = TopRoles[r % TopRoles.Length];
            var rootDept = "Engineering";
            var rootBranch = branches[r % branches.Length];
            var root = AddEmployee(rootNames[r], null, null, rootRole, rootDept, rootBranch);

            for (int c = 0; c < 10; c++)
            {
                var childRole = "Engineering Manager";
                var childDept = departments[(r + c) % departments.Length];
                var childBranch = branches[(r + c) % branches.Length];
                var childName = $"{PickFirstName(rnd)} {PickLastName(rnd)}";
                var child = AddEmployee(childName, root.EmployeeId, root.CommonId, childRole, childDept, childBranch);
                root.HasReports = true;

                for (int gc = 0; gc < pageCount; gc++)
                {
                    var leafRole = roles[2 + ((r + c + gc) % (roles.Length - 2))];
                    var leafDept = departments[(r + c + gc) % departments.Length];
                    var leafBranch = branches[(r + c + gc) % branches.Length];
                    var leafName = $"{PickFirstName(rnd)} {PickLastName(rnd)}";
                    var leaf = AddEmployee(leafName, child.EmployeeId, child.CommonId, leafRole, leafDept, leafBranch);
                    child.HasReports = true;

                    if (rnd.Next(100) < 40)
                    {
                        int count = rnd.Next(1, 4);
                        for (int i = 0; i < count; i++)
                        {
                            leaf.Badges.Add(AllowedBadges[(r + c + gc + i) % AllowedBadges.Length]);
                        }
                    }
                }
            }
        }

        var byId = list.ToDictionary(e => e.EmployeeId);
        foreach (var e in list)
        {
            if (e.ManagerId is int mid && byId.TryGetValue(mid, out var mgr))
                e.ManagerName = mgr.Name;
        }

        // UPDATED: Assign projects with rules:
        // - Short names only
        // - 1 or 2 projects per person
        // - Child's projects must be a subset of its parent's projects
        AssignProjectsHierarchy(list);

        return list;
    }

    // UPDATED: New project assignment logic (replaces previous seeding/inheritance)
    private static void AssignProjectsHierarchy(List<EmployeeNode> list)
    {
        var rnd = new Random(1357);
        var childrenByManager = list
            .Where(x => x.ManagerId.HasValue)
            .GroupBy(x => x.ManagerId!.Value)
            .ToDictionary(g => g.Key, g => g.ToList());

        var roots = list.Where(x => x.ManagerId is null).ToList();

        foreach (var root in roots)
        {
            // Root gets 1 or 2 projects from the short-name pool
            var rootCount = rnd.Next(1, 3); // 1..2
            root.Projects = ProjectsPool.OrderBy(_ => rnd.Next()).Take(rootCount).ToList();
            DFS(root);
        }

        void DFS(EmployeeNode parent)
        {
            if (!childrenByManager.TryGetValue(parent.EmployeeId, out var kids))
                return;

            foreach (var child in kids)
            {
                // Child must pick 1 or 2 from parent's projects (subset only)
                var available = parent.Projects;
                int maxTake = Math.Min(2, available.Count);
                int minTake = Math.Min(1, available.Count);

                int take = (maxTake >= 1) ? rnd.Next(minTake, maxTake + 1) : 0;

                var chosen = (take > 0)
                    ? available.OrderBy(_ => rnd.Next()).Take(take).ToList()
                    : new List<string>();

                // If parent has at least 1, ensure child has at least 1
                if (chosen.Count == 0 && available.Count > 0)
                    chosen.Add(available[0]);

                child.Projects = chosen;

                DFS(child);
            }
        }
    }

    private static string PickFirstName(Random rnd)
    {
        string[] first = { "Noah", "Liam", "Emma", "Olivia", "Sophia", "Isabella", "Mia", "Charlotte", "Ava", "Elijah", "James", "Benjamin", "Lucas", "Mason", "Ethan", "Alexander", "Henry", "Jacob", "Michael", "Daniel" };
        return first[rnd.Next(first.Length)];
    }
    private static string PickLastName(Random rnd)
    {
        string[] last = { "Smith", "Johnson", "Williams", "Brown", "Jones", "Garcia", "Miller", "Davis", "Rodriguez", "Martinez", "Hernandez", "Lopez", "Gonzalez", "Wilson", "Anderson", "Thomas", "Taylor", "Moore", "Jackson", "Martin" };
        return last[rnd.Next(last.Length)];
    }
    private static string PickWorkingStatus(Random rnd, string branch)
    {
        int roll = rnd.Next(100);
        if (roll < 45) return $"Available - {branch}";
        if (roll < 60) return "Available - Working From Home";
        if (roll < 75) return "On Lunch";
        if (roll < 88) return "On Casual Leave";
        if (roll < 96) return "In Permission";
        return "In Sick Leave";
    }
    private static string SafeId(string s) => s.Replace(" ", "").Replace("+", "Plus");

    // Allowed badges
    private static readonly string[] AllowedBadges = new[]
    {
        "Achiever", "Best Ideation", "Brilliant", "Star Performer", "Wonderful", "Good Work"
    };

    // If a row has no badges from data, derive some deterministically (stable across renders)
    private static List<string> DeriveBadges(EmployeeNode emp)
    {
        int count = GetTier(emp.AchievementPoints).Name switch
        {
            "Bronze" => 1,
            "Bronze+" => 2,
            "Silver" => 3,
            "Silver+" => 4,
            "Gold" => 5,
            _ => 6
        };
        return AllowedBadges
            .OrderBy(b => ((emp.EmployeeId * 397) ^ b.GetHashCode()) & int.MaxValue)
            .Take(count)
            .ToList();
    }

    // Emoji + background style for each badge (no external images)
    private static string BadgeEmoji(string badge) => badge switch
    {
        "Achiever" => "??",
        "Best Ideation" => "??",
        "Brilliant" => "??",
        "Star Performer" => "?",
        "Wonderful" => "??",
        "Good Work" => "??",
        _ => "??"
    };
    private static string BadgeStyle(string badge) => badge switch
    {
        "Achiever" => "background:#fde68a;",
        "Best Ideation" => "background:#fee2e2;",
        "Brilliant" => "background:#dcfce7;",
        "Star Performer" => "background:#e9d5ff;",
        "Wonderful" => "background:#cffafe;",
        "Good Work" => "background:#dbeafe;",
        _ => "background:#e5e7eb;"
    };

    private static string Initials(string fullName)
    {
        if (string.IsNullOrWhiteSpace(fullName)) return "NA";
        var parts = fullName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length == 1) return parts[0].Substring(0, Math.Min(2, parts[0].Length)).ToUpperInvariant();
        char first = parts[0][0];
        char last = parts[^1][0];
        return $"{char.ToUpperInvariant(first)}{char.ToUpperInvariant(last)}";
    }

    private static readonly (string bg, string fg, string brd)[] InitialsPalette = new[]
    {
        ("#dbeafe","#1e3a8a","#bfdbfe"),
        ("#ffe4e6","#9f1239","#fecdd3"),
        ("#dcfce7","#065f46","#bbf7d0"),
        ("#fde68a","#92400e","#fcd34d"),
        ("#ddd6fe","#5b21b6","#c4b5fd"),
        ("#bae6fd","#075985","#7dd3fc"),
        ("#fce7f3","#831843","#fbcfe8"),
        ("#e9d5ff","#6b21a8","#d8b4fe"),
        ("#fde2e2","#7f1d1d","#fecaca"),
        ("#e2f2ff","#0b4a6f","#c7e0ff")
    };
    private static (string bg, string fg, string brd) InitialsColor(string name)
    {
        var idx = Math.Abs(name?.GetHashCode() ?? 0) % InitialsPalette.Length;
        return InitialsPalette[idx];
    }

    private (string bg, string fg, string border) RoleChipStyle(string role) => role switch
    {
        "VP of Engineering" => ("linear-gradient(90deg,#c7d2fe,#bfdbfe)", "#1e3a8a", "#c7d2fe"),
        "Head of Engineering" => ("linear-gradient(90deg,#ddd6fe,#c4b5fd)", "#4c1d95", "#c4b5fd"),
        "Director of Software Engineering" => ("linear-gradient(90deg,#e9d5ff,#d8b4fe)", "#5b21b6", "#d8b4fe"),
        "Director of Platform Engineering" => ("linear-gradient(90deg,#cffafe,#bae6fd)", "#075985", "#a5f3fc"),
        "Executive" => ("linear-gradient(90deg,#eef2ff,#e0e7ff)", "#1e3a8a", "#c7d2fe"),
        "Leadership" => ("linear-gradient(90deg,#e0f2fe,#ccfbf1)", "#075985", "#bae6fd"),
        "Management" => ("linear-gradient(90deg,#fff7ed,#fde68a)", "#9a3412", "#fed7aa"),
        "Manager" => ("linear-gradient(90deg,#fef3c7,#fde68a)", "#92400e", "#fde68a"),
        "Engineering Manager" => ("linear-gradient(90deg,#fee2e2,#fecaca)", "#7f1d1d", "#fecaca"),
        "Director of Engineering" => ("linear-gradient(90deg,#ddd6fe,#c4b5fd)", "#4c1d95", "#c4b5fd"),
        "Product Manager" => ("linear-gradient(90deg,#e0f2fe,#bfdbfe)", "#075985", "#bae6fd"),
        "Program Manager" => ("linear-gradient(90deg,#fef9c3,#fde68a)", "#854d0e", "#fde68a"),
        "Scrum Master" => ("linear-gradient(90deg,#dcfce7,#bbf7d0)", "#065f46", "#a7f3d0"),
        "Software Engineer" => ("linear-gradient(90deg,#e0f2fe,#dbeafe)", "#075985", "#bfdbfe"),
        "Senior Software Engineer" => ("linear-gradient(90deg,#d1fae5,#a7f3d0)", "#065f46", "#99f6e4"),
        "Front End Engineer" => ("linear-gradient(90deg,#ffe4e6,#fecdd3)", "#9f1239", "#fecaca"),
        "Back End Engineer" => ("linear-gradient(90deg,#ede9fe,#ddd6fe)", "#5b21b6", "#c4b5fd"),
        "Full Stack Engineer" => ("linear-gradient(90deg,#fef9c3,#fde68a)", "#854d0e", "#fde68a"),
        "Site Reliability Engineer" => ("linear-gradient(90deg,#e0f2fe,#ccfbf1)", "#065f46", "#a7f3d0"),
        "DevOps Engineer" => ("linear-gradient(90deg,#bae6fd,#7dd3fc)", "#0c4a6e", "#7dd3fc"),
        "Cloud Platform Engineer" => ("linear-gradient(90deg,#cffafe,#bae6fd)", "#075985", "#a5f3fc"),
        "Platform Engineer" => ("linear-gradient(90deg,#e0f2fe,#bfdbfe)", "#075985", "#bfdbfe"),
        "Data Engineer" => ("linear-gradient(90deg,#dcfce7,#a7f3d0)", "#065f46", "#86efac"),
        "Quality Assurance Engineer" => ("linear-gradient(90deg,#f1f5f9,#e5e7eb)", "#111827", "#e5e7eb"),
        "Automation Test Engineer" => ("linear-gradient(90deg,#e9d5ff,#d8b4fe)", "#5b21b6", "#d8b4fe"),
        "Security Engineer" => ("linear-gradient(90deg,#fee2e2,#fecaca)", "#7f1d1d", "#fecaca"),
        "Security Analyst" => ("linear-gradient(90deg,#fee2e2,#fecaca)", "#7f1d1d", "#fecaca"),
        "Network Engineer" => ("linear-gradient(90deg,#e0f2fe,#bae6fd)", "#0c4a6e", "#93c5fd"),
        _ => ("linear-gradient(90deg,#e0f2fe,#ccfbf1)", "#0f172a", "#bae6fd")
    };

    private (string status, string where) ParseWorkingStatus(string raw)
    {
        if (string.IsNullOrWhiteSpace(raw)) return ("Unknown", "");
        var parts = raw.Split(" - ", 2, StringSplitOptions.TrimEntries | StringSplitOptions.RemoveEmptyEntries);
        return parts.Length == 2 ? (parts[0], parts[1]) : (raw, "");
    }
    private (string bg, string fg, string dot) WorkingStatusBadgeColors(string status)
    {
        if (status.Equals("Available", StringComparison.OrdinalIgnoreCase)) return ("#ecfdf5", "#065f46", "#10b981");
        if (status.Equals("Absent", StringComparison.OrdinalIgnoreCase)) return ("#f3f4f6", "#374151", "#9ca3af");
        if (status.Equals("In Sick Leave", StringComparison.OrdinalIgnoreCase)) return ("#fef2f2", "#991b1b", "#ef4444");
        if (status.Equals("In Permission", StringComparison.OrdinalIgnoreCase)) return ("#fffbeb", "#92400e", "#f59e0b");
        if (status.Equals("On Lunch", StringComparison.OrdinalIgnoreCase)) return ("#fff7ed", "#9a3412", "#fb923c");
        if (status.Equals("On Casual Leave", StringComparison.OrdinalIgnoreCase)) return ("#fef9c3", "#854d0e", "#f59e0b");
        return ("#e0f2fe", "#075985", "#38bdf8");
    }

    private record Tier(string Name, int Min, int Max);
    private static readonly Tier[] Tiers = new[]
    {
        new Tier("Bronze",0,149), new Tier("Bronze+",150,299),
        new Tier("Silver",300,499), new Tier("Silver+",500,749),
        new Tier("Gold",750,999), new Tier("Gold+",1000,1249),
        new Tier("Platinum",1250,1499), new Tier("Diamond",1500,2000)
    };
    private static Tier GetTier(int points) => Tiers.Last(t => points >= t.Min);
    private static int? NextThreshold(Tier t) { var i = Array.IndexOf(Tiers, t); return i == Tiers.Length - 1 ? null : Tiers[i + 1].Min; }
    private static string TierName(int threshold) => Tiers.First(t => t.Min == threshold).Name;
    private static (string c1, string c2) TierGradient(string tier) => tier switch
    {
        "Bronze" => ("#E0A080", "#C07045"),
        "Bronze+" => ("#E6B091", "#C98159"),
        "Silver" => ("#E5E7EB", "#9CA3AF"),
        "Silver+" => ("#F1F5F9", "#A8AFB8"),
        "Gold" => ("#FFD54A", "#E6A500"),
        "Gold+" => ("#FFDD72", "#F2A54C"),
        "Platinum" => ("#B4F0F0", "#7ED6D4"),
        "Diamond" => ("#BDE0FE", "#7CC0FE"),
        _ => ("#E5E7EB", "#9CA3AF")
    };

    private static (string code, string country) BranchCountry(string branch) => branch switch
    {
        "Argentina" => ("ar", "Argentina"),
        "Brazil" => ("br", "Brazil"),
        "Bulgaria" => ("bg", "Bulgaria"),
        "Chile" => ("cl", "Chile"),
        "Colombia" => ("co", "Colombia"),
        "Croatia" => ("hr", "Croatia"),
        "Czechoslovakia" => ("cz", "Czechoslovakia"),
        "England" => ("gb-eng", "England"),
        "France" => ("fr", "France"),
        "Germany" => ("de", "Germany"),
        "Hungary" => ("hu", "Hungary"),
        "Italy" => ("it", "Italy"),
        "Japan" => ("jp", "Japan"),
        "Mexico" => ("mx", "Mexico"),
        "Poland" => ("pl", "Poland"),
        "Portugal" => ("pt", "Portugal"),
        "Qatar" => ("qa", "Qatar"),
        "Russia" => ("ru", "Russia"),
        "South Africa" => ("za", "South Africa"),
        "South Korea" => ("kr", "South Korea"),
        "Spain" => ("es", "Spain"),
        "Sweden" => ("se", "Sweden"),
        "Switzerland" => ("ch", "Switzerland"),
        "United States" => ("us", "United States"),
        "Uruguay" => ("uy", "Uruguay"),
        "West Germany" => ("de", "West Germany"),
        _ => ("", "")
    };

    public class EmployeeNode
    {
        public int EmployeeId { get; set; }
        public int? ManagerId { get; set; }
        public bool HasReports { get; set; }
        public string Name { get; set; } = "";
        public string Gender { get; set; } = "Male";
        public string Email { get; set; } = "";
        public string Designation { get; set; } = "";
        public string Role { get; set; } = "";
        public string Department { get; set; } = "";
        public string Branch { get; set; } = "";
        public string WorkingStatus { get; set; } = "Available - Working From Home";
        public int TotalLeaveCount { get; set; }
        public DateTime DateJoined { get; set; }
        public string PhotoUrl { get; set; } = "";
        public string? ManagerName { get; set; }
        public List<string> Projects { get; set; } = new();
        public string ProjectsCsv => string.Join(", ", Projects);
        public int AchievementPoints { get; set; }
        public int CommonId { get; set; }
        public int? ParentCommonId { get; set; }
        public List<string> Badges { get; set; } = new();
        public string BadgesCsv => string.Join(", ", Badges);
    }
}