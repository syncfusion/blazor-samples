@page "/tree-grid/customsorting"
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.TreeGrid
@using Syncfusion.Blazor.Buttons


@*Hidden:Lines*@
@using TaskData
@inherits SampleBaseComponent;
@inject NavigationManager NavigationManager
@inject Microsoft.AspNetCore.Components.NavigationManager UriHelper
@*End:Hidden*@

<ActionDescription>
<p>
    This sample demonstrates applying custom sorting logic. Columns can be ordered based on a predefined sequence rather than default alphabetical or numeric sorting.
  </p>
  <p>
    Enable sorting by setting <a target="_blank" rel="noopener" href="https://help.syncfusion.com/cr/blazor/Syncfusion.Blazor.TreeGrid.SfTreeGrid-1.html#Syncfusion_Blazor_TreeGrid_SfTreeGrid_1_AllowSorting">AllowSorting</a> to <strong>true</strong>. Click column headers to sort.
  </p>
  <p>
    In this demo, custom sort logic is applied via <a target="_blank" rel="noopener" href="https://help.syncfusion.com/cr/blazor/Syncfusion.Blazor.TreeGrid.html#Syncfusion_Blazor_TreeGrid_TreeGridColumn_SortComparer">SortComparer</a>:
  </p>
  <ul>
    <li><strong>Priority</strong>: custom sequence – Low, Normal, High, Critical</li>
    <li><strong>RICE Score</strong>: numeric sorting, even though values are stored as strings</li>
  </ul>
  <p>
    Learn more in the <a target="_blank" rel="noopener" href="https://blazor.syncfusion.com/documentation/treegrid/sorting#custom-sorting">custom sorting documentation</a>.
  </p>
</ActionDescription>




<div class="col-lg-12 control-section">
    <div class="content-wrapper">
        <div class="row">
            <SfTreeGrid ID="treeCustomSorting" DataSource="@TreeGridData" 
                        IdMapping="TaskID" 
                        ParentIdMapping="ParentID" 
                        TreeColumnIndex="1" 
                        AllowFiltering="true" 
                        AllowSorting="true" 
                        Height="500">
                <TreeGridFilterSettings Type="Syncfusion.Blazor.TreeGrid.FilterType.Excel"></TreeGridFilterSettings>
                <TreeGridColumns>
                    <TreeGridColumn Field="TaskID" HeaderText="Task ID" Width="100" TextAlign="TextAlign.Right"></TreeGridColumn>
                    <TreeGridColumn Field="TaskName" HeaderText="Task Name" Width="280"></TreeGridColumn>
                    <TreeGridColumn Field="AssignedTo" HeaderText="Assignee" Width="140"></TreeGridColumn>

                    <TreeGridColumn Field="Priority" HeaderText="Priority" Width="120" SortComparer="@(new PriorityComparer())">
                        <Template>
                            @{
                                var task = (context as TaskData);
                                var priority = task?.Priority;
                            }
                            @if (priority == "Critical")
                            {
                                <div class="title-temp1 critical">
                                    <img src="@UriHelper.ToAbsoluteUri($"{SampleService?.WebAssetsPath}images/data-grid/critical.png")" class="priority" />
                                    <span class="font">@priority</span>
                                </div>
                            }
                            else if (priority == "High")
                            {
                                <div class="title-temp1 high">
                                    <img src="@UriHelper.ToAbsoluteUri($"{SampleService?.WebAssetsPath}images/data-grid/high.png")" class="priority" />
                                    <span class="font">@priority</span>
                                </div>
                            }
                            else if (priority == "Normal")
                            {
                                <div class="title-temp1 normal">
                                    <img src="@UriHelper.ToAbsoluteUri($"{SampleService?.WebAssetsPath}images/data-grid/normal.png")" class="priority" />
                                    <span class="font">@priority</span>
                                </div>
                            }
                            else if (priority == "Low")
                            {
                                <div class="title-temp1 low">
                                    <img src="@UriHelper.ToAbsoluteUri($"{SampleService?.WebAssetsPath}images/data-grid/low.png")" class="priority" />
                                    <span class="font">@priority</span>
                                </div>
                            }
                        </Template>
                    </TreeGridColumn>

                    <!-- StoryPoints: Direct binding, no Template, numeric string sorting -->
                    <TreeGridColumn Field="StoryPoints" 
                                    HeaderText="Story Points" 
                                    Width="110" 
                                    TextAlign="TextAlign.Center"
                                    SortComparer="@(new StoryPointsStringComparer())" ClipMode="ClipMode.EllipsisWithTooltip">
                    </TreeGridColumn>

                    <TreeGridColumn Field="Progress" HeaderText="Status" Width="130">
                        <Template>
                            @{
                                var data = (context as TaskData);
                                var pillClass = data?.Progress switch
                                {
                                    "In Progress" => "pill-started",
                                    "Started" => "pill-started",
                                    "Open" => "pill-open",
                                    _ => "pill-instatus"
                                };
                            }
                            <span class="status-pill @pillClass">@data?.Progress</span>
                        </Template>
                    </TreeGridColumn>

                    <TreeGridColumn Field="StartDate" HeaderText="Start Date" Format="d" Type="ColumnType.Date" Width="120"></TreeGridColumn>
                    <TreeGridColumn Field="EndDate" HeaderText="End Date" Format="d" Type="ColumnType.Date" Width="120"></TreeGridColumn>
                </TreeGridColumns>
            </SfTreeGrid>
        </div>
    </div>
</div>

<style>
    #treeCustomSorting .priority { height: 16px; width: 16px; vertical-align: middle; margin-right: 6px; }
    #treeCustomSorting .status-pill {
        padding: 5px 10px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 12px;
    }
    #treeCustomSorting .pill-started { background: #d4edda; color: #155724; }
    #treeCustomSorting .pill-open { background: #d1ecf1; color: #0c5460; }
    #treeCustomSorting .pill-instatus { background: #e2e3e5; color: #383d41; }
</style>

@code {
    private List<TaskData> TreeGridData { get; set; } = new();

    protected override void OnInitialized()
    {
        TreeGridData = TaskData.GetTree();
    }

    // Numeric sorting for string StoryPoints (ascending: 2 → 30)
    public class StoryPointsStringComparer : IComparer<object>
    {
        public int Compare(object? x, object? y)
        {
            var a = x as TaskData;
            var b = y as TaskData;

            bool aHasValue = int.TryParse(a?.StoryPoints ?? "", out int valA);
            bool bHasValue = int.TryParse(b?.StoryPoints ?? "", out int valB);

            if (!aHasValue && !bHasValue) return 0;
            if (!aHasValue) return -1; // Empty comes first
            if (!bHasValue) return 1;

            return valA.CompareTo(valB); // Ascending order
        }
    }

    public class PriorityComparer : IComparer<object>
    {
        private static readonly Dictionary<string, int> Order = new()
        {
            { "Low",      1 },
            { "Normal",   2 },
            { "High",     3 },
            { "Critical", 4 }
        };

        public int Compare(object? x, object? y)
        {
            var a = x as TaskData;
            var b = y as TaskData;

            int pa = Order.GetValueOrDefault(a?.Priority ?? "", 0);
            int pb = Order.GetValueOrDefault(b?.Priority ?? "", 0);

            // Ascending order: Low → Normal → High → Critical
            return pa.CompareTo(pb);
        }
    }
}