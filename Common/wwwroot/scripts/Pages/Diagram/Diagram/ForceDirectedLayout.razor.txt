@page "/diagram/force-directed-layout"

@using Syncfusion.Blazor.Diagram
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.Navigations
@using Syncfusion.Blazor.Popups;
@using Syncfusion.Blazor.Inputs
@using NodeShape = Syncfusion.Blazor.Diagram.NodeShapes
@*Hidden:Lines*@
@inherits SampleBaseComponent
@implements IDisposable
<ActionDescription>
<p>This sample demonstrates force-directed tree layout using simulated physical forces to automatically position nodes and edges for well-organized graph visualization.</p>

<p>Layout customization:</p>
<ul>
  <li><code><a target="_blank" rel="noopener" href="https://help.syncfusion.com/cr/blazor/Syncfusion.Blazor.Diagram.ForceDirectedTreeLayoutSettings.html#Syncfusion_Blazor_Diagram_ForceDirectedTreeLayoutSettings_AttractionStrength" aria-label="Navigate to AttractionStrength property">AttractionStrength</a></code>: Controls how strongly connected nodes pull toward each other</li>
  <li><code><a target="_blank" rel="noopener" href="https://help.syncfusion.com/cr/blazor/Syncfusion.Blazor.Diagram.ForceDirectedTreeLayoutSettings.html#Syncfusion_Blazor_Diagram_ForceDirectedTreeLayoutSettings_RepulsionStrength" aria-label="Navigate to RepulsionStrength property">RepulsionStrength</a></code>: Determines how forcefully nodes push away to prevent overlap</li>
  <li><code><a target="_blank" rel="noopener" href="https://help.syncfusion.com/cr/blazor/Syncfusion.Blazor.Diagram.ForceDirectedTreeLayoutSettings.html#Syncfusion_Blazor_Diagram_ForceDirectedTreeLayoutSettings_MaximumIteration" aria-label="Navigate to MaximumIteration property">MaximumIteration</a></code>: Specifies simulation cycles for layout stabilization</li>
  <li><code><a target="_blank" rel="noopener" href="https://help.syncfusion.com/cr/blazor/Syncfusion.Blazor.Diagram.ForceDirectedTreeLayoutSettings.html#Syncfusion_Blazor_Diagram_ForceDirectedTreeLayoutSettings_ConnectorLength" aria-label="Navigate to ConnectorLength property">ConnectorLength</a></code>: Sets ideal distance between connected nodes</li>
  <li>Zoom in and out for layout exploration</li>
  <li>Reset zoom to default view</li>
</ul>
</ActionDescription>

@*End:Hidden*@

<div class="col-lg-12 control-section" style="width:100%;">

    <style>
        .texstyle {
            display: table;
            height: 35px;
            padding-right: 4px;
            padding-left: 0px;
            width: 50%;
            padding-top: 10px;
            float: left;
            position: relative;
            min-height: 1px;
        }

        .textboxlablestyle {
            padding-left: 0px;
            padding-right: 0px;
            float: left;
            width: 40%;
        }

        .textboxstyle {
            padding-left: 0px;
            padding-right: 0px;
            float: left;
            width: 60%;
        }

        .row {
            margin-left: 0px;
            margin-right: 0px;
            display: block;
        }

        .e-bigger .e-btn.e-small.e-icon-btn {
            padding: 0px;
        }

        /* Keep toolbar 'selected' look (used by tb-item-selected classes) */
        .e-toolbar .e-toolbar-items .e-toolbar-item.tb-item-selected .e-tbar-btn.e-btn,
        .e-toolbar .e-toolbar-items .e-toolbar-item .e-dropdown-btn.tb-item-selected {
            background: #7d7d7d;
        }

        .e-toolbar .e-toolbar-items .e-toolbar-item.tb-item-selected .e-tbar-btn .e-icons.e-btn-icon,
        .e-toolbar .e-toolbar-items .e-toolbar-item .e-dropdown-btn.tb-item-selected .e-btn-icon {
            color: #ffffff;
        }

        .sb-mobile-diagram {
            border: 1px solid #d9dedd;
        }

    </style>
    @*End:Hidden*@
    <div>
        <SfToolbar>
            <ToolbarItems>
                <ToolbarItem @ref="@ZoomInItem" Text="Zoom In" TooltipText="Zoom in" CssClass="@ZoomInItemCssClass" PrefixIcon="e-icons e-zoom-in" OnClick="@OnZoomInItemClick"></ToolbarItem>
                <ToolbarItem Type="ItemType.Separator"></ToolbarItem>
                <ToolbarItem @ref="@ZoomOutItem" Text="Zoom Out" TooltipText="Zoom out" CssClass="@ZoomOutItemCssClass" PrefixIcon="e-icons e-zoom-out" OnClick="@OnZoomOutItemClick"></ToolbarItem>
                <ToolbarItem Type="ItemType.Separator"></ToolbarItem>
                <ToolbarItem OnClick="@OnResetClick" Text="Reset" Disabled="@reset" CssClass="@ResetCssClass" PrefixIcon="e-icons e-refresh" @ref="@ResetItem" TooltipText="Reset">
                </ToolbarItem>
            </ToolbarItems>
        </SfToolbar>
    </div>

    <div class="col-lg-9 control-section" style="border-right: 1px solid #D7D7D7">
        <SfDiagramComponent @ref="@diagram" Height="690px" Width="100%" @bind-Nodes="@Nodes" @bind-Connectors="@Connectors" Created="OnCreated" InteractionController="@DiagramTool">
            <ScrollSettings CurrentZoomChanged="@CurrentZoomChanged"></ScrollSettings>
            <SnapSettings Constraints="@SnapConstraints.None"></SnapSettings>
            <Layout Type="LayoutType.ForceDirectedTree" ForceDirectedTreeLayoutSettings="@settings">
            </Layout>
        </SfDiagramComponent>
    </div>
    <div class="col-lg-3 property-section">
        <div class="property-panel-header">
            Properties
        </div>
        <div id="propertypanel" class="e-remove-selection">
            <div class="property-section-content property-panel-content">
                <div class="row" style="padding-top: 8px">
                    <div style="display: table;height: 30px;" class="textboxlablestyle">
                        <div style="display: table-cell; vertical-align: middle">Connector Length</div>
                    </div>
                    <div class="textboxstyle" style="padding-left:10px">
                        <SfNumericTextBox TValue="double" Width="100%" @bind-Value="@ConnectorLength" Min="100" Max="200" Step="5" Format="###.##">
                            <NumericTextBoxEvents TValue="double" ValueChange="OnConnectorLengthChange"></NumericTextBoxEvents>
                        </SfNumericTextBox>
                    </div>
                </div>
                <div class="row" style="padding-top: 8px">
                    <div style="display: table;height: 30px;" class="textboxlablestyle">
                        <div style="display: table-cell; vertical-align: middle">Maximum Iteration</div>
                    </div>
                    <div class="textboxstyle" style="padding-left:10px">
                        <SfNumericTextBox TValue="int" Width="100%" @bind-Value="@maxIteration" Min="500" Max="1500" Step="50" Format="###.##">
                            <NumericTextBoxEvents TValue="int" ValueChange="OnIterationChange"></NumericTextBoxEvents>
                        </SfNumericTextBox>
                    </div>
                </div>
                <div class="row" style="padding-top: 8px">
                    <div style="display: table;height: 30px;" class="textboxlablestyle">
                        <div style="display: table-cell; vertical-align: middle">Repulsion Strength</div>
                    </div>
                    <div class="textboxstyle" style="padding-left:10px">
                        <SfNumericTextBox TValue="int" Width="100%" @bind-Value="@repulsionStrength" Min="15000" Max="30000" Step="200" Format="###.##">
                            <NumericTextBoxEvents TValue="int" ValueChange="OnRepulsionStrengthChange"></NumericTextBoxEvents>
                        </SfNumericTextBox>
                    </div>
                </div>
                <div class="row" style="padding-top: 8px">
                    <div style="display: table;height: 30px;" class="textboxlablestyle">
                        <div style="display: table-cell; vertical-align: middle">Attraction Strength</div>
                    </div>
                    <div class="textboxstyle" style="padding-left:10px">
                        <SfNumericTextBox TValue="double" Width="100%" @bind-Value="@attractionStrength" Min="0.1" Max="1" Step=".1" Format="#.#">
                            <NumericTextBoxEvents TValue="double" ValueChange="OnAttractionStrengthChange"></NumericTextBoxEvents>
                        </SfNumericTextBox>
                    </div>
                </div>
            </div>
        </div>
    </div>
    @*Hidden:Lines*@
</div>


@*End:Hidden*@
@code {
    @*Hidden:Lines*@
    public DiagramInteractions DiagramTool = DiagramInteractions.ZoomPan;
    public DiagramObjectCollection<Node>? Nodes = new();
    public DiagramObjectCollection<Connector>? Connectors = new();
    public ForceDirectedTreeLayoutSettings settings = new ForceDirectedTreeLayoutSettings
    {
        ConnectorLength = 120,
        MaximumIteration = 1500,
        RepulsionStrength = 20000,
        AttractionStrength = 0.8
    };

    public double ConnectorLength = 120;
    public int maxIteration = 1500;
    public int repulsionStrength = 20000;
    public double attractionStrength = 0.8;

    public double currentZoom;
#pragma warning disable CS0414
    public string ZoomInItemCssClass = "tb-item-start";
    public string ZoomOutItemCssClass = "tb-item-start";
    public string ResetCssClass = "tb-item-start";
#pragma warning restore CS0414
    public bool reset = true;

    public ToolbarItem? ZoomInItem;
    public ToolbarItem? ZoomOutItem;
    public ToolbarItem? ResetItem;
    @*End:Hidden*@

    //Defines sfdiagramComponent
    public SfDiagramComponent? diagram;

    //Defines diagram constraints
    public DiagramConstraints constraints { get; set; }

    public void OnCreated()
    {
        FitOptions options = new FitOptions() { Mode = FitMode.Both, Region = DiagramRegion.Content };
        diagram!.FitToPage(options);
    }

    public void OnResetClick()
    {
        ZoomInItemCssClass = "tb-item-start";
        ZoomOutItemCssClass = "tb-item-start";
        ResetCssClass = "tb-item-start";
        diagram!.ResetZoom();
        OnCreated();
        reset = true;
    }

    // Easy sizing controls
    public int DepartmentsUnderCeo { get; set; } = 4;
    public int ManagersPerDepartment { get; set; } = 4;
    public int TeamsPerManager { get; set; } = 6;

    public void CurrentZoomChanged(double args)
    {
        reset = (diagram!.ScrollSettings!.CurrentZoom) == 1 ? true : false;
    }

    protected override void OnInitialized()
    {
        PopulateDiagram();
    }

    public void PopulateDiagram()
    {
        List<OrgItem> data = GetCompanyOrgData();
        PopulateDiagramFromData(data);
    }
    public void PopulateDiagramFromData(IEnumerable<OrgItem> items)
    {
        Dictionary<string, OrgItem> byId = items.ToDictionary(x => x.Id);

        foreach (OrgItem item in items)
        {
            Node node = CreateOrgNode(item);
            Nodes!.Add(node);

            if (!string.IsNullOrEmpty(item.ParentId) && byId.ContainsKey(item.ParentId))
            {
                Connectors!.Add(CreateConnector(item.ParentId, item.Id));
            }
        }
    }

    public Node CreateOrgNode(OrgItem item)
    {
        ShapeStyle style = new ShapeStyle { Fill = "orange", StrokeWidth = 2, StrokeColor = "#8c8c8c" };
        double width = 35; double height = 35;
        Shape shape = new BasicShape() { Shape = NodeBasicShapes.Ellipse, }; // use Shapes.Basic

        switch (item.Level)
        {
            case OrgLevel.Header:
                style.Fill = "#f39c12";
                width = height = 140;
                shape = new BasicShape { Shape = NodeBasicShapes.Ellipse };
                break;
            case OrgLevel.Department:
                style.Fill = "#27ae60";
                width = height = 120;
                shape = new BasicShape { Shape = NodeBasicShapes.Ellipse};
                break;
            case OrgLevel.Manager:
                style.Fill = "#2980b9";
                shape = new BasicShape { Shape = NodeBasicShapes.Ellipse};
                width = height = 100;
                break;
            case OrgLevel.Team:
                style.Fill = "#f39c12";
                shape = new BasicShape { Shape = NodeBasicShapes.Ellipse};
                width = height = 80;
                break;
        }

        return new Node
        {
            ID = item.Id,
            Width = width,
            Height = height,
            Shape = shape,
            Annotations = new DiagramObjectCollection<ShapeAnnotation>
            {
                new ShapeAnnotation { ID = $"{item.Id}_label", Content = item.Name, Style = new TextStyle(){ FontSize = 18, Bold = true, Color = "white" } }
            },
            Style = style
        };
    }

    public Connector CreateConnector(string sourceId, string targetId)
    {
        return new Connector
        {
            ID = $"{sourceId}_{targetId}",
            SourceID = sourceId,
            TargetID = targetId,
            Type = ConnectorSegmentType.Straight
        };
    }
    FitOptions options = new FitOptions() { Mode = FitMode.Both, Region = DiagramRegion.Content };

    public void OnConnectorLengthChange(Syncfusion.Blazor.Inputs.ChangeEventArgs<double> args)
    {
        settings.ConnectorLength = ConnectorLength = args.Value;
    }

    public void OnIterationChange(Syncfusion.Blazor.Inputs.ChangeEventArgs<int> args)
    {
        settings.MaximumIteration = maxIteration = args.Value;
    }

    public void OnRepulsionStrengthChange(Syncfusion.Blazor.Inputs.ChangeEventArgs<int> args)
    {
        settings.RepulsionStrength = repulsionStrength = args.Value;
    }

    public void OnAttractionStrengthChange(Syncfusion.Blazor.Inputs.ChangeEventArgs<double> args)
    {
        settings.AttractionStrength = attractionStrength = args.Value;
    }

    public enum OrgLevel
    {
        Header,
        Department,
        Manager,
        Team
    }

    public class OrgItem
    {
        public string Id { get; set; } = "";
        public string? ParentId { get; set; }
        public string Name { get; set; } = "";
        public OrgLevel Level { get; set; }
    }

    // Parametrized generator
    public static List<OrgItem> BuildOrgData(int departments, int managersPerDept, int teamsPerManager)
    {
        List<OrgItem> data = new List<OrgItem>
        {
            new OrgItem { Id = "departments", ParentId = null, Name = "Departments", Level = OrgLevel.Header }
        };

        // Departments
        for (int d = 1; d <= departments; d++)
        {
            string deptId = $"dept_{d}";
            data.Add(new OrgItem { Id = deptId, ParentId = "departments", Name = $"Department {d}", Level = OrgLevel.Department });

            // Managers
            for (int m = 1; m <= managersPerDept; m++)
            {
                string mgrId = $"{deptId}_mgr_{m}";
                data.Add(new OrgItem { Id = mgrId, ParentId = deptId, Name = $"Manager {d}.{m}", Level = OrgLevel.Manager });

                // Teams
                for (int t = 1; t <= teamsPerManager; t++)
                {
                    string teamId = $"{mgrId}_team_{t}";
                    data.Add(new OrgItem
                    {
                        Id = teamId,
                        ParentId = mgrId,
                        Name = $"Team {d}.{m}.{t}",
                        Level = OrgLevel.Team
                    });
                }
            }
        }

        return data;
    }

    // A realistic software-company hierarchy: 1 CEO has 4 depts each with 4 managers each to 6 teams each
    public static List<OrgItem> GetCompanyOrgData()
    {
        List<OrgItem> data = new List<OrgItem>();

        // CEO
        data.Add(new OrgItem { Id = "departments", ParentId = null, Name = "Departments", Level = OrgLevel.Header });

        // Departments (Level 2)
        List<OrgItem> departments = new List<OrgItem>
        {
            new OrgItem { Id = "uxTeam", ParentId = "departments", Name = "UX Team", Level = OrgLevel.Department },
            new OrgItem { Id = "devTeam", ParentId = "departments", Name = "Development Team", Level = OrgLevel.Department },
            new OrgItem { Id = "salesTeam", ParentId = "departments", Name = "Sales Team", Level = OrgLevel.Department },
            new OrgItem { Id = "hrTeam", ParentId = "departments", Name = "HR Team", Level = OrgLevel.Department }
        };
        foreach (OrgItem d in departments)
            data.Add(d);

        // Managers per department (Level 3) for 4 per department
        Dictionary<string, (string id, string name)[]> managersByDept = new Dictionary<string, (string id, string name)[]>
        {
            ["uxTeam"] = new[]
            {
                ("mgr1", "Manager-1"),
                ("mgr2", "Manager-2"),
            },
            ["devTeam"] = new[]
            {
                ("po1", "PO-1"),
                ("po2", "PO-2"),
                ("po3", "PO-3"),
                ("po4", "PO-4"),
            },
            ["salesTeam"] = new[]
            {
                ("agm1", "AGM-1"),
                ("agm2", "AGM-2"),
            },
            ["hrTeam"] = new[]
            {
                ("hr_mgr", "Manager"),
            },
        };

        foreach (string dept in managersByDept.Keys)
        {
            foreach ((string id, string name) m in managersByDept[dept])
                data.Add(new OrgItem { Id = m.id, ParentId = dept, Name = m.name, Level = OrgLevel.Manager });
        }

        // Teams per manager (Level 4) variable per requirements
        Dictionary<string, int> teamCountByManager = new Dictionary<string, int>
        {
            ["mgr1"] = 3,
            ["mgr2"] = 3,
            ["po1"] = 4,
            ["po2"] = 4,
            ["po3"] = 4,
            ["po4"] = 4,
            ["agm1"] = 3,
            ["agm2"] = 3,
            ["hr_mgr"] = 2,
        };

        foreach (string dept in managersByDept.Keys)
        {
            foreach ((string mid, string mname) mm in managersByDept[dept])
            {
                int count = teamCountByManager.ContainsKey(mm.mid) ? teamCountByManager[mm.mid] : 0;
                for (int i = 1; i <= count; i++)
                {
                    string teamId = $"{mm.mid}_t{i}";
                    data.Add(new OrgItem
                    {
                        Id = teamId,
                        ParentId = mm.mid,
                        Name = $"Team-{i}",
                        Level = OrgLevel.Team
                    });
                }
            }
        }

        return data;
    }
    public void OnZoomInItemClick()
    {
        ZoomInItemCssClass = "tb-item-start";
        ZoomOutItemCssClass = "tb-item-start";
        ResetCssClass = "tb-item-start";
        diagram!.Zoom(1.2, new DiagramPoint() { X = 100, Y = 100 });
        reset = false;
    }
    public void ZoomChanged()
    {
        reset = false;
    }
    public void OnZoomOutItemClick()
    {
        ZoomInItemCssClass = "tb-item-start";
        ZoomOutItemCssClass = "tb-item-start";
        ResetCssClass = "tb-item-start";
        diagram!.Zoom(1 / 1.2, new DiagramPoint() { X = 100, Y = 100 });
        reset = false;
    }

    @*Hidden:Lines*@
    public void Dispose()
    {
        if (Nodes != null)
        {
            Nodes.Clear();
            Nodes = null;
        }
        if (Connectors != null)
        {
            Connectors.Clear();
            Connectors = null;
        }
    }
    @*End:Hidden*@
  
}
